#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#define STRESS_COUNTER 10240
char i2c_set_page[][29] = {"i2cset -y 1 0x48 0xff 0x00 b", "i2cset -y 1 0x48 0xff 0x30 b"};
int ref[116] = {0xc0, 0xc0, 0x00, 0x01, 0x00, 0x01, 0x87, 0x01, 0xc3, 0x01, 0x00, 0x01, 0x00, 0x01, 0x80, 0x01, 0x00, 0x01,
0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01,
0x00, 0x01, 0x01, 0x02, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01,
0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x18, 0x01, 0x00, 0x01, 0x3f, 0x30, 0x06, 0x04, 
0x40, 0x01, 0x40, 0x01, 0x82, 0x83, 0x82, 0x83, 0x82, 0x83, 0xc8, 0xc0, 0xc7, 0xc1, 0xc6, 0xc1, 0xc5, 0xc1, 
0xc4, 0xc1, 0xc3, 0xc1, 0xc2, 0xc1, 0xc1, 0xc0, 0xc0, 0xc1, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 
0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01};
char i2c_set_page_default[29] = {"i2cset -y 1 0x48 0xff 0x00 b"};
char i2c_get_reg[116][34] = 
{"i2cget -y 1 0x48 0x00 b >temp.txt",/*0x00 reg test cases*/
"i2cget -y 1 0x48 0x01 b >temp.txt",
"i2cget -y 1 0x48 0x02 b >temp.txt",
"i2cget -y 1 0x48 0x03 b >temp.txt",
"i2cget -y 1 0x48 0x04 b >temp.txt",
"i2cget -y 1 0x48 0x0a b >temp.txt",
"i2cget -y 1 0x48 0x0b b >temp.txt",
"i2cget -y 1 0x48 0x0c b >temp.txt",
"i2cget -y 1 0x48 0x0e b >temp.txt",
"i2cget -y 1 0x48 0x0f b >temp.txt",
"i2cget -y 1 0x48 0x10 b >temp.txt",
"i2cget -y 1 0x48 0x11 b >temp.txt",
"i2cget -y 1 0x48 0x12 b >temp.txt",
"i2cget -y 1 0x48 0x13 b >temp.txt",
"i2cget -y 1 0x48 0x14 b >temp.txt",
"i2cget -y 1 0x48 0x15 b >temp.txt",
"i2cget -y 1 0x48 0x16 b >temp.txt",
"i2cget -y 1 0x48 0x17 b >temp.txt",
"i2cget -y 1 0x48 0x18 b >temp.txt",
"i2cget -y 1 0x48 0x19 b >temp.txt",
"i2cget -y 1 0x48 0x1a b >temp.txt",
"i2cget -y 1 0x48 0x1b b >temp.txt",
"i2cget -y 1 0x48 0x1c b >temp.txt",
"i2cget -y 1 0x48 0x1d b >temp.txt",
"i2cget -y 1 0x48 0x1e b >temp.txt",
"i2cget -y 1 0x48 0x1f b >temp.txt",
"i2cget -y 1 0x48 0x20 b >temp.txt",
"i2cget -y 1 0x48 0x60 b >temp.txt",
"i2cget -y 1 0x48 0x61 b >temp.txt",
"i2cget -y 1 0x48 0x62 b >temp.txt",
"i2cget -y 1 0x48 0x63 b >temp.txt",
"i2cget -y 1 0x48 0x7c b >temp.txt",
"i2cget -y 1 0x48 0x7d b >temp.txt",
"i2cget -y 1 0x48 0x7e b >temp.txt",
"i2cget -y 1 0x48 0x7f b >temp.txt",
"i2cget -y 1 0x48 0xe9 b >temp.txt",
"i2cget -y 1 0x48 0xea b >temp.txt",
"i2cget -y 1 0x48 0xeb b >temp.txt",
"i2cget -y 1 0x48 0xec b >temp.txt",
"i2cget -y 1 0x48 0xed b >temp.txt",
"i2cget -y 1 0x48 0xee b >temp.txt",
"i2cget -y 1 0x48 0xef b >temp.txt",
"i2cget -y 1 0x48 0xf0 b >temp.txt",
"i2cget -y 1 0x48 0xf1 b >temp.txt",
"i2cget -y 1 0x48 0xf2 b >temp.txt",
"i2cget -y 1 0x48 0xf3 b >temp.txt",
"i2cget -y 1 0x48 0xf4 b >temp.txt",
"i2cget -y 1 0x48 0xf5 b >temp.txt",
"i2cget -y 1 0x48 0xf6 b >temp.txt",
"i2cget -y 1 0x48 0xf7 b >temp.txt",/*0x00 reg test cases*/
"i2cget -y 1 0x48 0x00 b >temp.txt",/*0x30 reg test cases*/
"i2cget -y 1 0x48 0x01 b >temp.txt",
"i2cget -y 1 0x48 0x02 b >temp.txt",
"i2cget -y 1 0x48 0x03 b >temp.txt",
"i2cget -y 1 0x48 0x04 b >temp.txt",
"i2cget -y 1 0x48 0x04 b >temp.txt",
"i2cget -y 1 0x48 0x10 b >temp.txt",
"i2cget -y 1 0x48 0x11 b >temp.txt",
};
char i2c_set_reg_default[58][29] = 
{"i2cset -y 1 0x48 0x00 0xc0 b",
"i2cset -y 1 0x48 0x01 0x00 b",
"i2cset -y 1 0x48 0x02 0x00 b",
"i2cset -y 1 0x48 0x03 0x00 b",
"i2cset -y 1 0x48 0x04 0xc3 b",
"i2cset -y 1 0x48 0x0a 0x00 b",
"i2cset -y 1 0x48 0x0b 0x00 b",
"i2cset -y 1 0x48 0x0c 0x80 b",
"i2cset -y 1 0x48 0x0e 0x00 b",
"i2cset -y 1 0x48 0x0f 0x01 b",
"i2cset -y 1 0x48 0x10 0x00 b",
"i2cset -y 1 0x48 0x11 0x00 b",
"i2cset -y 1 0x48 0x12 0x6d b",
"i2cset -y 1 0x48 0x13 0x79 b",
"i2cset -y 1 0x48 0x14 0x19 b",
"i2cset -y 1 0x48 0x15 0x10 b",
"i2cset -y 1 0x48 0x16 0x3e b",
"i2cset -y 1 0x48 0x17 0x00 b",
"i2cset -y 1 0x48 0x18 0x00 b",
"i2cset -y 1 0x48 0x19 0x00 b",
"i2cset -y 1 0x48 0x1a 0x00 b",
"i2cset -y 1 0x48 0x1b 0x00 b",
"i2cset -y 1 0x48 0x1c 0x00 b",
"i2cset -y 1 0x48 0x1d 0x00 b",
"i2cset -y 1 0x48 0x1e 0x00 b",
"i2cset -y 1 0x48 0x1f 0x00 b",
"i2cset -y 1 0x48 0x20 0x00 b",
"i2cset -y 1 0x48 0x60 0x00 b",
"i2cset -y 1 0x48 0x61 0x8f b",
"i2cset -y 1 0x48 0x62 0xaa b",
"i2cset -y 1 0x48 0x63 0xfe b",
"i2cset -y 1 0x48 0x7c 0x00 b",
"i2cset -y 1 0x48 0x7d 0x18 b",
"i2cset -y 1 0x48 0x7e 0x00 b",
"i2cset -y 1 0x48 0x7f 0x3f b",
"i2cset -y 1 0x48 0xe9 0x06 b",
"i2cset -y 1 0x48 0xea 0x40 b",
"i2cset -y 1 0x48 0xeb 0x40 b",
"i2cset -y 1 0x48 0xec 0x82 b",
"i2cset -y 1 0x48 0xed 0x82 b",
"i2cset -y 1 0x48 0xee 0x82 b",
"i2cset -y 1 0x48 0xef 0xc8 b",
"i2cset -y 1 0x48 0xf0 0xc7 b",
"i2cset -y 1 0x48 0xf1 0xc6 b",
"i2cset -y 1 0x48 0xf2 0xc5 b",
"i2cset -y 1 0x48 0xf3 0xc4 b",
"i2cset -y 1 0x48 0xf4 0xc3 b",
"i2cset -y 1 0x48 0xf5 0xc2 b",
"i2cset -y 1 0x48 0xf6 0xc1 b",
"i2cset -y 1 0x48 0xf7 0xc0 b",
"i2cset -y 1 0x48 0x00 0x00 b",/*0x30 reg test cases*/
"i2cset -y 1 0x48 0x01 0x00 b",
"i2cset -y 1 0x48 0x02 0x00 b",
"i2cset -y 1 0x48 0x03 0x00 b",
"i2cset -y 1 0x48 0x04 0x00 b",
"i2cset -y 1 0x48 0x04 0x00 b",
"i2cset -y 1 0x48 0x10 0x01 b",
"i2cset -y 1 0x48 0x11 0x01 b",/*0x30 reg test cases*/
};
char i2c_set_reg[116][29] = 
{"i2cset -y 1 0x48 0x00 0xc0 b",/*0x00 reg test cases*/
"i2cset -y 1 0x48 0x00 0xc0 b",
"i2cset -y 1 0x48 0x01 0x00 b",
"i2cset -y 1 0x48 0x01 0x01 b",
"i2cset -y 1 0x48 0x02 0x00 b",
"i2cset -y 1 0x48 0x02 0x01 b",
"i2cset -y 1 0x48 0x03 0x87 b",
"i2cset -y 1 0x48 0x03 0x01 b", //1
"i2cset -y 1 0x48 0x04 0xc3 b",
"i2cset -y 1 0x48 0x04 0x01 b",
"i2cset -y 1 0x48 0x0a 0x00 b",
"i2cset -y 1 0x48 0x0a 0x01 b",
"i2cset -y 1 0x48 0x0b 0x00 b",
"i2cset -y 1 0x48 0x0b 0x01 b",
"i2cset -y 1 0x48 0x0c 0x80 b",
"i2cset -y 1 0x48 0x0c 0x01 b", //2
"i2cset -y 1 0x48 0x0e 0x00 b",
"i2cset -y 1 0x48 0x0e 0x01 b",
"i2cset -y 1 0x48 0x0f 0x00 b",
"i2cset -y 1 0x48 0x0f 0x01 b",
"i2cset -y 1 0x48 0x10 0x00 b",
"i2cset -y 1 0x48 0x10 0x01 b",
"i2cset -y 1 0x48 0x11 0x00 b",
"i2cset -y 1 0x48 0x11 0x01 b", //3
"i2cset -y 1 0x48 0x12 0x00 b",
"i2cset -y 1 0x48 0x12 0x01 b",
"i2cset -y 1 0x48 0x13 0x00 b",
"i2cset -y 1 0x48 0x13 0x01 b",
"i2cset -y 1 0x48 0x14 0x00 b",
"i2cset -y 1 0x48 0x14 0x01 b",
"i2cset -y 1 0x48 0x15 0x00 b",
"i2cset -y 1 0x48 0x15 0x01 b", //4
"i2cset -y 1 0x48 0x16 0x00 b",
"i2cset -y 1 0x48 0x16 0x01 b",
"i2cset -y 1 0x48 0x17 0x00 b",
"i2cset -y 1 0x48 0x17 0x01 b",
"i2cset -y 1 0x48 0x18 0x00 b",
"i2cset -y 1 0x48 0x18 0x01 b",
"i2cset -y 1 0x48 0x19 0x01 b",
"i2cset -y 1 0x48 0x19 0x02 b", //5
"i2cset -y 1 0x48 0x1a 0x00 b",
"i2cset -y 1 0x48 0x1a 0x01 b",
"i2cset -y 1 0x48 0x1b 0x00 b",
"i2cset -y 1 0x48 0x1b 0x01 b",
"i2cset -y 1 0x48 0x1c 0x00 b",
"i2cset -y 1 0x48 0x1c 0x01 b",
"i2cset -y 1 0x48 0x1d 0x00 b",
"i2cset -y 1 0x48 0x1d 0x01 b", //6
"i2cset -y 1 0x48 0x1e 0x00 b",
"i2cset -y 1 0x48 0x1e 0x01 b",
"i2cset -y 1 0x48 0x1f 0x00 b",
"i2cset -y 1 0x48 0x1f 0x01 b",
"i2cset -y 1 0x48 0x20 0x00 b",
"i2cset -y 1 0x48 0x20 0x01 b",
"i2cset -y 1 0x48 0x60 0x00 b",
"i2cset -y 1 0x48 0x60 0x01 b", //7
"i2cset -y 1 0x48 0x61 0x00 b",
"i2cset -y 1 0x48 0x61 0x01 b",
"i2cset -y 1 0x48 0x62 0x00 b",
"i2cset -y 1 0x48 0x62 0x01 b",
"i2cset -y 1 0x48 0x63 0x00 b",
"i2cset -y 1 0x48 0x63 0x01 b",
"i2cset -y 1 0x48 0x7c 0x00 b",
"i2cset -y 1 0x48 0x7c 0x01 b", //8
"i2cset -y 1 0x48 0x7d 0x18 b",
"i2cset -y 1 0x48 0x7d 0x01 b",
"i2cset -y 1 0x48 0x7e 0x00 b",
"i2cset -y 1 0x48 0x7e 0x01 b",
"i2cset -y 1 0x48 0x7f 0x3f b",
"i2cset -y 1 0x48 0x7f 0x30 b",
"i2cset -y 1 0x48 0xe9 0x06 b",
"i2cset -y 1 0x48 0xe9 0x04 b", //9
"i2cset -y 1 0x48 0xea 0x40 b",
"i2cset -y 1 0x48 0xea 0x01 b",
"i2cset -y 1 0x48 0xeb 0x40 b",
"i2cset -y 1 0x48 0xeb 0x01 b",
"i2cset -y 1 0x48 0xec 0x82 b",
"i2cset -y 1 0x48 0xec 0x83 b",
"i2cset -y 1 0x48 0xed 0x82 b",
"i2cset -y 1 0x48 0xed 0x83 b", //10
"i2cset -y 1 0x48 0xee 0x82 b",
"i2cset -y 1 0x48 0xee 0x83 b",
"i2cset -y 1 0x48 0xef 0xc8 b",
"i2cset -y 1 0x48 0xef 0xc0 b",
"i2cset -y 1 0x48 0xf0 0xc7 b",
"i2cset -y 1 0x48 0xf0 0xc1 b",
"i2cset -y 1 0x48 0xf1 0xc6 b",
"i2cset -y 1 0x48 0xf1 0xc1 b", //11
"i2cset -y 1 0x48 0xf2 0xc5 b",
"i2cset -y 1 0x48 0xf2 0xc1 b",
"i2cset -y 1 0x48 0xf3 0xc4 b",
"i2cset -y 1 0x48 0xf3 0xc1 b",
"i2cset -y 1 0x48 0xf4 0xc3 b",
"i2cset -y 1 0x48 0xf4 0xc1 b",
"i2cset -y 1 0x48 0xf5 0xc2 b",
"i2cset -y 1 0x48 0xf5 0xc1 b", //12
"i2cset -y 1 0x48 0xf6 0xc1 b",
"i2cset -y 1 0x48 0xf6 0xc0 b",
"i2cset -y 1 0x48 0xf7 0xc0 b",
"i2cset -y 1 0x48 0xf7 0xc1 b",/*0x00 reg test cases*/
"i2cset -y 1 0x48 0x00 0x00 b",/*0x30 reg test cases*/
"i2cset -y 1 0x48 0x00 0x01 b",//1
"i2cset -y 1 0x48 0x01 0x00 b",
"i2cset -y 1 0x48 0x01 0x01 b",//2
"i2cset -y 1 0x48 0x02 0x00 b",
"i2cset -y 1 0x48 0x02 0x01 b",//3
"i2cset -y 1 0x48 0x03 0x00 b",
"i2cset -y 1 0x48 0x03 0x01 b",//4
"i2cset -y 1 0x48 0x04 0x00 b",
"i2cset -y 1 0x48 0x04 0x01 b",//5
"i2cset -y 1 0x48 0x04 0x00 b",
"i2cset -y 1 0x48 0x04 0x01 b",//6
"i2cset -y 1 0x48 0x10 0x00 b",
"i2cset -y 1 0x48 0x10 0x01 b",//7
"i2cset -y 1 0x48 0x11 0x00 b",
"i2cset -y 1 0x48 0x11 0x01 b",//8/*0x30 reg test cases*/
};
int main(int argc, char *argv[])
{
	int set_page = 0;
	int reg_test = 0;
	int stress = -1;
	int res1 = 0;
	int res2 = 0;
	FILE *fp = fopen("test_result.txt", "w");
	if(argc < 4)
	{
		printf("\nPlease enter valid number of arguments: binary page_to_test register_to_test\n");
		fflush(fp);
		fprintf(fp, "%d", -2);
		fclose(fp);
		return -2;
	}
	set_page = atoi(argv[1]);
	reg_test = atoi(argv[2]);
	stress = atoi(argv[3]);
	if(!stress)
	{
		if(((set_page == 0)&&((reg_test<=49)&&(reg_test>=0)))||((set_page == 1)&&((reg_test<=57)&&(reg_test>=50))))
		{
        		int reg_get = 0x00;
			FILE *sfp = NULL;
			system(i2c_set_page[set_page]);
			printf("\n%s\n", i2c_set_page[set_page]);
			sleep(1);
			system(i2c_set_reg[2*reg_test]);
			printf("\n%s\n", i2c_set_reg[2*reg_test]);
			sleep(1);
			system(i2c_get_reg[reg_test]);
			printf("\n%s\n", i2c_get_reg[reg_test]);
			sleep(1);
			sfp = fopen("temp.txt", "r");
				fscanf(sfp, "%x", &reg_get);
			fclose(sfp);
			if(ref[reg_test + 1] == reg_get)
			{
				res1 = 0;
			}
			reg_get = 0x00;
			system(i2c_set_reg[2*reg_test + 1]);
			printf("\n%s\n", i2c_set_reg[2*reg_test + 1]);
			sleep(1);
			system(i2c_get_reg[reg_test]);
			printf("\n%s\n", i2c_get_reg[reg_test]);
			sleep(1);
			sfp = fopen("temp.txt", "r");
				fscanf(sfp, "%x", &reg_get);
			fclose(sfp);
			if(ref[2*reg_test + 1] == reg_get)
			{
				res2 = 0;
			}
			reg_get = 0x00;
			system(i2c_set_page[set_page]);
			printf("\n%s\n", i2c_set_page[set_page]);
			sleep(1);
			system(i2c_set_reg_default[reg_test]);
			printf("\n%s\n", i2c_set_reg_default[reg_test]);
			sleep(1);
			system(i2c_set_page_default);
			printf("\n%s\n", i2c_set_page_default);
			sleep(1);
			if(res2||res1)
			{
				printf("\nTest failed\n");
				if(res1)
				{
					printf("\nFailed to set default value mentioned in data sheet\n");
				}
				if(res2)
				{
					printf("\nFailed to set value with in the range other than default one mentioned in data sheet\n");
				}
				sleep(1);
				fflush(fp);
				fprintf(fp, "%d", 1);
				fclose(fp);
				return 1;
			}
			printf("\nTest passed\n");
			sleep(1);
			fflush(fp);
			fprintf(fp, "%d", 0);
			fclose(fp);
			return 0;
		}
		else
		{
			printf("\nunable to test due to invalid argument\n");
			fflush(fp);
			fprintf(fp, "%d", -1);
			fclose(fp);
			return -2;
		}
	}
	else if(stress == 1)
	{
		int counter = 0;
		if(((set_page == 0)&&((reg_test<=49)&&(reg_test>=0)))||((set_page == 1)&&((reg_test<=57)&&(reg_test>=50))))
		{
			while(counter != STRESS_COUNTER)
			{
				int reg_get = 0x00;
				FILE *sfp = NULL;
				if(counter)
				{
					fp = fopen("test_result.txt", "w");
				}
				system(i2c_set_page[set_page]);
				printf("\n%s\n", i2c_set_page[set_page]);
				sleep(1);
				system(i2c_set_reg[2 * reg_test]);
				printf("\n%s\n", i2c_set_reg[2*reg_test]);
				sleep(1);
				system(i2c_get_reg[reg_test]);
				printf("\n%s\n", i2c_get_reg[reg_test]);
				sleep(1);
				sfp = fopen("temp.txt", "r");
				fscanf(sfp, "%x", &reg_get);
				fclose(sfp);
				if(ref[reg_test + 1] == reg_get)
				{
					res1 |= 0;
				}
				else
				{
					res1 |= 1;
				}
				reg_get = 0x00;
				system(i2c_set_reg[2*reg_test + 1]);
				printf("\n%s\n", i2c_set_reg[2*reg_test + 1]);
				sleep(1);
				system(i2c_get_reg[reg_test]);
				printf("\n%s\n", i2c_get_reg[reg_test]);
				sleep(1);
				sfp = fopen("temp.txt", "r");
					fscanf(sfp, "%x", &reg_get);
				fclose(sfp);
				if(ref[2*reg_test + 1] == reg_get)
				{
					res2 |= 0;
				}
				else
				{
					res2 |= 1;
				}
				reg_get = 0x00;
				system(i2c_set_page[set_page]);
				printf("\n%s\n", i2c_set_page[set_page]);
				sleep(1);
				system(i2c_set_reg_default[reg_test]);
				printf("\n%s\n", i2c_set_reg_default[reg_test]);
				sleep(1);
				system(i2c_set_page_default);
				printf("\n%s\n", i2c_set_page_default);
				sleep(1);
				if(res2||res1)
				{
					printf("\nTest failed\n");
					if(res1)
					{
						printf("\nFailed to set default value mentioned in data sheet\n");
					}
					if(res2)
					{
						printf("\nFailed to set value with in the range other than default one mentioned in data sheet\n");
					}
					sleep(1);
					fflush(fp);
					fprintf(fp, "%d", 1);
					fclose(fp);
					return 1;
				}
				printf("\nTest passed\n");
				sleep(1);
				fflush(fp);
				fprintf(fp, "%d", 0);
				fclose(fp);
				counter++;
			}
		}
		else
		{
			printf("\nunable to test due to invalid argument\n");
			fflush(fp);
			fprintf(fp, "%d", -1);
			fclose(fp);
			return -2;
		}
	}
	return 0;
}
